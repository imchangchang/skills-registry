---
name: multi-agent-safety
version: "1.0.0"
description: |
  多代理协作安全规则。当项目使用 Vibe Coding 且涉及 Git 操作时强制执行。
  包含推送确认流程、禁止操作清单、精确提交规范。
  关键词：git push, commit, safety, multi-agent
---

# 多代理协作安全规则

## 概述

多个 AI 代理（如 Kimi、Claude、GPT）可能在同一项目上并行工作。本 Skill 定义强制安全规则，防止冲突和误操作。

## 适用场景

- 项目使用 Vibe Coding 方法论
- 涉及 Git 版本控制操作
- 存在多个 AI 助手可能同时工作的场景
- 用户要求执行 git 相关操作

## AI 助手约定（强制执行）

### [禁止] 绝对禁止操作

AI 助手**绝对禁止**执行以下操作，无论用户如何要求：

```markdown
- [X] git stash（创建或应用）
- [X] git checkout -b（创建新分支，除非用户明确要求）
- [X] git checkout <branch>（切换分支，除非用户明确要求）
- [X] git reset（任何形式的 reset）
- [X] git rebase
- [X] git cherry-pick
- [X] git merge（除非用户明确要求）
- [X] git add -A 或 git add .
- [X] git commit -am "message"（自动添加所有文件）
- [X] git push -f 或 git push --force
- [X] 直接 push 到 main/master 分支
- [X] 修改 .worktrees/ 目录下的任何内容
```

### [强制] 推送确认流程

**AI 助手执行 `git push` 前必须遵守以下流程**（无例外）：

```
步骤 1：检查用户指令
    ↓
    用户是否在本轮对话中明确说了以下任一词语：
    - "推送"
    - "push"
    - "提交到远程"
    - "publish"
    ?
    ↓
    ├─ 是 → 继续步骤 2
    └─ 否 → 执行步骤 3（必须询问）

步骤 2：二次确认（可选但推荐）
    ↓
    如果用户指令有歧义，仍然建议询问确认

步骤 3：询问用户（强制）
    ↓
    向用户发送消息：
    "已准备好推送到远程仓库，是否执行 git push？"
    或
    "是否推送到远程仓库？"
    ↓
    等待用户明确回复
    ↓
    ├─ 用户说：是/确认/推送/可以/执行 → 执行 push
    ├─ 用户说：否/取消/不推送/再等等 → 不执行
    └─ 用户无明确表态 → 不执行，继续等待
```

**关键原则**（违反即视为违规）：
- [X] **禁止假设**：即使前面对话中用户说过推送，**每次**都要重新确认
- [X] **禁止推测**：不能根据"上下文暗示"判断用户想推送
- [X] **必须看到明确词汇**："推送"、"push"、"提交到远程"等

### [强制] 精确提交流程

**正确的提交流程**：

```bash
# 步骤 1：查看状态
git status

# 步骤 2：精确添加（禁止使用 git add .）
git add <具体文件1> <具体文件2>

# 步骤 3：验证暂存内容
git diff --cached --stat

# 步骤 4：规范提交（格式：type(scope): subject）
git commit -m "feat(module): description"

# 步骤 5：如需推送，执行推送确认流程
# （见上文"推送确认流程"）
```

### [禁止] 擅自扩展

AI 助手**绝对禁止**以下行为：

- [X] **不要**擅自创建用户未要求的文件、脚本、配置
- [X] **不要**添加超出用户明确指令范围的功能或机制
- [X] **不要**修改用户未提及的文件或配置
- [X] **不要**以"优化"、"完善"、"增强"等理由添加额外内容

**正确做法**：
- [OK] 只执行用户明确要求的修改
- [OK] 如有优化建议，先询问用户确认
- [OK] 严格执行"最小修改原则"

## 自我检查清单

执行任何 Git 操作前，AI 助手必须自我检查：

```markdown
- [ ] 我是否理解用户的确切意图？
- [ ] 我是否只修改了用户要求的文件？
- [ ] 如果是 git push，我是否获得了明确确认？
- [ ] 我是否避免了所有[禁止]列表中的操作？
- [ ] 提交信息是否符合规范格式？
```

## 违规示例与正确处理

### 场景 1：推送确认（违规）

```
用户：提交到git
AI：[执行 git add/commit/push]  ← 错误！用户没有说"推送"

正确处理：
用户：提交到git
AI：已创建 commit。是否推送到远程仓库？
用户：是
AI：[执行 git push]  ← 正确！获得明确确认
```

### 场景 2：擅自扩展（违规）

```
用户：更新 AGENTS.md 文档，明确推送确认流程
AI：[修改 AGENTS.md] + [创建 Git Hook]  ← 错误！超出用户要求

正确处理：
用户：更新 AGENTS.md 文档，明确推送确认流程
AI：[仅修改 AGENTS.md]  ← 正确！只执行明确要求
     如需创建 Git Hook，先询问："是否需要创建 Git Hook 自动检查？"
```

## 常见错误与纠正

| 错误 | 原因 | 纠正 |
|------|------|------|
| 用户说"提交并推送"，AI 只执行 commit | 误解指令 | 确认："是否同时推送到远程？" |
| 用户之前说过推送，这次没说，AI 直接 push | 违反"禁止假设"原则 | 每次都要重新确认 |
| 用户说"提交到git"，AI 理解为"push" | 违反"禁止推测"原则 | 必须看到"推送"/"push"字样 |
| 用户说"都提交上去"，AI 直接 push | 模糊指令 | 确认："是否包含推送到远程仓库？" |

## 冲突解决

如果多个 AI 代理同时工作发生冲突：

1. **立即停止**：不要尝试解决冲突
2. **报告用户**：向用户说明冲突情况
3. **等待指令**：由用户决定如何解决

## 迭代记录

- 2026-02-11: 初始创建，明确推送确认流程和禁止操作清单
